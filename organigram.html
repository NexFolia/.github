<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NexFolia Organizational Chart</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: #FAFAF5;
      color: #334155;
      overflow: hidden;
    }

    /* ── Header ── */
    #header {
      padding: 20px 32px 0;
      background: #FAFAF5;
    }

    #header h1 {
      font-family: 'Outfit', 'Inter', system-ui, sans-serif;
      font-size: 1.75rem;
      font-weight: 700;
      color: #0F172A;
      letter-spacing: 0.01em;
    }

    #header h1 .nex { color: #0D5C63; }
    #header h1 .folia { color: #2E8B57; }

    /* ── Legend bar ── */
    #legend {
      display: flex;
      align-items: center;
      gap: 24px;
      padding: 12px 32px;
      background: #FAFAF5;
      flex-wrap: wrap;
    }

    .legend-items {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8125rem;
      font-weight: 500;
      color: #334155;
    }

    .legend-swatch {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      flex-shrink: 0;
    }

    .legend-summary {
      font-size: 0.8125rem;
      color: #94A3B8;
      margin-left: 8px;
    }

    .legend-summary span { color: #334155; font-weight: 500; }

    /* ── Chart container ── */
    #chart-container {
      width: 100%;
      overflow: hidden;
      position: relative;
    }

    #chart {
      width: 100%;
      height: 100%;
    }

    /* ── Controls bar ── */
    #controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 32px;
      background: #FAFAF5;
      border-top: 1px solid #E2E8F0;
      flex-wrap: wrap;
    }

    .ctrl-btn {
      font-family: 'Inter', system-ui, sans-serif;
      font-size: 0.8125rem;
      font-weight: 500;
      padding: 6px 16px;
      border: 1px solid #CBD5E1;
      border-radius: 6px;
      background: #FFFFFF;
      color: #334155;
      cursor: pointer;
      transition: all 0.15s ease;
      user-select: none;
    }

    .ctrl-btn:hover {
      background: #F1F5F9;
      border-color: #94A3B8;
    }

    .ctrl-btn:active {
      background: #E2E8F0;
    }

    .ctrl-btn.active {
      background: #0D5C63;
      color: #FFFFFF;
      border-color: #0D5C63;
    }

    .ctrl-btn.active:hover {
      background: #0A4A50;
    }

    /* ── Footer ── */
    #footer {
      padding: 8px 32px;
      text-align: center;
      font-size: 0.75rem;
      color: #94A3B8;
      background: #FAFAF5;
    }

    /* ── Tooltip ── */
    #tooltip {
      position: fixed;
      display: none;
      background: #0F172A;
      color: #F8FAFC;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 0.75rem;
      line-height: 1.5;
      max-width: 300px;
      pointer-events: none;
      z-index: 9999;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }

    #tooltip .tt-title {
      font-weight: 600;
      font-size: 0.8125rem;
      margin-bottom: 4px;
      color: #F8FAFC;
    }

    #tooltip .tt-label {
      color: #94A3B8;
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 2px;
    }

    #tooltip .tt-agent {
      color: #E2E8F0;
      padding-left: 2px;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div id="header">
    <h1><span class="nex">Nex</span><span class="folia">Folia</span> Organizational Chart</h1>
  </div>

  <!-- Legend -->
  <div id="legend">
    <div class="legend-items">
      <div class="legend-item">
        <div class="legend-swatch" style="background: #2E8B57;"></div>
        Human
      </div>
      <div class="legend-item">
        <div class="legend-swatch" style="background: #0D5C63;"></div>
        Hybrid
      </div>
      <div class="legend-item">
        <div class="legend-swatch" style="background: #00B894;"></div>
        AI
      </div>
    </div>
    <div class="legend-summary">
      <span>6</span> Human &middot; <span>16</span> Hybrid &middot; <span>9</span> AI &middot; <span>31</span> Total
    </div>
  </div>

  <!-- Chart -->
  <div id="chart-container">
    <div id="chart"></div>
  </div>

  <!-- Controls -->
  <div id="controls">
    <button class="ctrl-btn" onclick="chart.expandAll().fit()">Expand All</button>
    <button class="ctrl-btn" onclick="chart.collapseAll().fit()">Collapse All</button>
    <button class="ctrl-btn" onclick="chart.fit()">Fit</button>
    <button class="ctrl-btn" id="compactBtn" onclick="toggleCompact()">Compact</button>
    <button class="ctrl-btn" onclick="exportChart()">Export PNG</button>
  </div>

  <!-- Footer -->
  <div id="footer">
    Part of the <strong>NexFolia</strong> organization &middot; AI-native organizational structure
  </div>

  <!-- Tooltip -->
  <div id="tooltip"></div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-org-chart@3.1.1"></script>
  <script>
    // ── Set chart container height ──
    function setChartHeight() {
      var header = document.getElementById('header');
      var legend = document.getElementById('legend');
      var controls = document.getElementById('controls');
      var footer = document.getElementById('footer');
      var container = document.getElementById('chart-container');
      var used = header.offsetHeight + legend.offsetHeight + controls.offsetHeight + footer.offsetHeight;
      container.style.height = (window.innerHeight - used) + 'px';
    }
    setChartHeight();

    // ── Org Data (31 roles) ──
    const data = [
      {
        id: "ceo",
        parentId: "",
        title: "Chief Executive Officer",
        shortTitle: "CEO",
        department: "C-Suite",
        classification: "human",
        level: "c-suite",
        linkedAgents: 0,
        agentList: ""
      },
      {
        id: "cto",
        parentId: "ceo",
        title: "Chief Technology Officer",
        shortTitle: "CTO",
        department: "C-Suite",
        classification: "hybrid",
        level: "c-suite",
        linkedAgents: 3,
        agentList: "architect-review, code-reviewer, architecture-modernizer"
      },
      {
        id: "cfo",
        parentId: "ceo",
        title: "Chief Financial Officer",
        shortTitle: "CFO",
        department: "C-Suite",
        classification: "hybrid",
        level: "c-suite",
        linkedAgents: 2,
        agentList: "business-analyst, risk-manager"
      },
      {
        id: "product-manager",
        parentId: "ceo",
        title: "Product Manager",
        shortTitle: "PM",
        department: "Product",
        classification: "hybrid",
        level: "senior",
        linkedAgents: 2,
        agentList: "product-strategist, business-analyst"
      },
      {
        id: "head-of-design",
        parentId: "ceo",
        title: "Head of Design",
        shortTitle: "Head of Design",
        department: "Design",
        classification: "ai",
        level: "director",
        linkedAgents: 2,
        agentList: "premium-ui-ux-architect, design-system-auditor"
      },
      {
        id: "general-counsel",
        parentId: "ceo",
        title: "General Counsel",
        shortTitle: "GC",
        department: "Legal",
        classification: "human",
        level: "director",
        linkedAgents: 0,
        agentList: ""
      },
      {
        id: "marketing-director",
        parentId: "ceo",
        title: "Marketing Director",
        shortTitle: "Mkt. Director",
        department: "Marketing & Sales",
        classification: "human",
        level: "director",
        linkedAgents: 0,
        agentList: ""
      },
      {
        id: "sales-director",
        parentId: "ceo",
        title: "Sales Director",
        shortTitle: "Sales Director",
        department: "Marketing & Sales",
        classification: "human",
        level: "director",
        linkedAgents: 0,
        agentList: ""
      },
      {
        id: "operations-manager",
        parentId: "ceo",
        title: "Operations Manager",
        shortTitle: "Ops Manager",
        department: "Operations",
        classification: "hybrid",
        level: "senior",
        linkedAgents: 1,
        agentList: "business-analyst"
      },
      {
        id: "vp-engineering",
        parentId: "cto",
        title: "VP Engineering",
        shortTitle: "VP Eng",
        department: "Engineering",
        classification: "human",
        level: "vp",
        linkedAgents: 0,
        agentList: ""
      },
      {
        id: "senior-fullstack-engineer",
        parentId: "vp-engineering",
        title: "Senior Full Stack Engineer",
        shortTitle: "Sr. Full Stack",
        department: "Engineering",
        classification: "hybrid",
        level: "senior",
        linkedAgents: 3,
        agentList: "fullstack-developer, code-reviewer, debugger"
      },
      {
        id: "backend-engineer",
        parentId: "vp-engineering",
        title: "Backend Engineer",
        shortTitle: "Backend Eng",
        department: "Engineering",
        classification: "hybrid",
        level: "mid",
        linkedAgents: 3,
        agentList: "backend-architect, debugger, performance-profiler"
      },
      {
        id: "frontend-engineer",
        parentId: "vp-engineering",
        title: "Frontend Engineer",
        shortTitle: "Frontend Eng",
        department: "Engineering",
        classification: "hybrid",
        level: "mid",
        linkedAgents: 3,
        agentList: "frontend-developer, ui-ux-designer, code-reviewer"
      },
      {
        id: "devops-engineer",
        parentId: "vp-engineering",
        title: "DevOps Engineer",
        shortTitle: "DevOps Eng",
        department: "Engineering",
        classification: "hybrid",
        level: "senior",
        linkedAgents: 2,
        agentList: "devops-engineer, cloud-migration-specialist"
      },
      {
        id: "qa-engineer",
        parentId: "vp-engineering",
        title: "QA Engineer",
        shortTitle: "QA Eng",
        department: "Engineering",
        classification: "ai",
        level: "mid",
        linkedAgents: 2,
        agentList: "test-engineer, error-detective"
      },
      {
        id: "business-analyst",
        parentId: "product-manager",
        title: "Business Analyst",
        shortTitle: "BA",
        department: "Product",
        classification: "hybrid",
        level: "mid",
        linkedAgents: 2,
        agentList: "business-analyst, marketing-attribution-analyst"
      },
      {
        id: "data-analyst",
        parentId: "business-analyst",
        title: "Data Analyst",
        shortTitle: "Data Analyst",
        department: "Product",
        classification: "ai",
        level: "mid",
        linkedAgents: 2,
        agentList: "business-analyst, marketing-attribution-analyst"
      },
      {
        id: "market-intelligence-analyst",
        parentId: "product-manager",
        title: "Market Intelligence Analyst",
        shortTitle: "MIA",
        department: "Product",
        classification: "ai",
        level: "mid",
        linkedAgents: 1,
        agentList: "market-intelligence-analyst"
      },
      {
        id: "ux-ui-designer",
        parentId: "head-of-design",
        title: "UX/UI Designer",
        shortTitle: "UX/UI",
        department: "Design",
        classification: "hybrid",
        level: "mid",
        linkedAgents: 2,
        agentList: "ui-ux-designer, cli-ui-designer"
      },
      {
        id: "senior-paralegal",
        parentId: "general-counsel",
        title: "Senior Paralegal",
        shortTitle: "Sr. Paralegal",
        department: "Legal",
        classification: "hybrid",
        level: "senior",
        linkedAgents: 1,
        agentList: "legal-advisor"
      },
      {
        id: "compliance-analyst",
        parentId: "general-counsel",
        title: "Compliance Analyst",
        shortTitle: "Compliance",
        department: "Legal",
        classification: "ai",
        level: "mid",
        linkedAgents: 2,
        agentList: "legal-advisor, risk-manager"
      },
      {
        id: "content-writer",
        parentId: "marketing-director",
        title: "Content Writer",
        shortTitle: "Content Writer",
        department: "Marketing & Sales",
        classification: "hybrid",
        level: "mid",
        linkedAgents: 2,
        agentList: "content-marketer, technical-writer"
      },
      {
        id: "seo-analytics-specialist",
        parentId: "marketing-director",
        title: "SEO/Analytics Specialist",
        shortTitle: "SEO/Analytics",
        department: "Marketing & Sales",
        classification: "ai",
        level: "mid",
        linkedAgents: 2,
        agentList: "marketing-attribution-analyst, content-marketer"
      },
      {
        id: "sdr",
        parentId: "sales-director",
        title: "Sales Development Rep",
        shortTitle: "SDR",
        department: "Marketing & Sales",
        classification: "ai",
        level: "junior",
        linkedAgents: 2,
        agentList: "sales-automator, customer-support"
      },
      {
        id: "hr-coordinator",
        parentId: "operations-manager",
        title: "HR Coordinator",
        shortTitle: "HR Coord.",
        department: "Operations",
        classification: "hybrid",
        level: "mid",
        linkedAgents: 2,
        agentList: "technical-writer, customer-support"
      },
      {
        id: "it-security-admin",
        parentId: "operations-manager",
        title: "IT/Security Administrator",
        shortTitle: "IT/Sec Admin",
        department: "Operations",
        classification: "hybrid",
        level: "senior",
        linkedAgents: 2,
        agentList: "mcp-expert, risk-manager"
      },
      {
        id: "head-of-ai-engineering",
        parentId: "cto",
        title: "Head of AI Engineering",
        shortTitle: "Head of AI Eng",
        department: "AI",
        classification: "human",
        level: "director",
        linkedAgents: 0,
        agentList: ""
      },
      {
        id: "mcp-architect",
        parentId: "head-of-ai-engineering",
        title: "MCP Architect",
        shortTitle: "MCP Architect",
        department: "AI",
        classification: "hybrid",
        level: "senior",
        linkedAgents: 1,
        agentList: "mcp-designer"
      },
      {
        id: "agent-orchestration-engineer",
        parentId: "head-of-ai-engineering",
        title: "Agent Orchestration Engineer",
        shortTitle: "Agent Orch Eng",
        department: "AI",
        classification: "hybrid",
        level: "senior",
        linkedAgents: 1,
        agentList: "agent-orchestrator"
      },
      {
        id: "context-engineer",
        parentId: "head-of-ai-engineering",
        title: "Context Engineer",
        shortTitle: "Context Eng",
        department: "AI",
        classification: "ai",
        level: "mid",
        linkedAgents: 2,
        agentList: "context-engineer, prompt-optimizer"
      },
      {
        id: "human-ai-collaboration-coordinator",
        parentId: "operations-manager",
        title: "Human/AI Collab Coordinator",
        shortTitle: "Human/AI Collab",
        department: "Operations",
        classification: "ai",
        level: "mid",
        linkedAgents: 1,
        agentList: "human-task-coordinator"
      }
    ];

    // ── Color config ──
    const classColors = {
      human:  "#2E8B57",
      hybrid: "#0D5C63",
      ai:     "#00B894"
    };

    const classLabels = {
      human:  "Human",
      hybrid: "Hybrid",
      ai:     "AI"
    };

    // ── State ──
    let isCompact = false;

    // ── Tooltip ──
    const tooltip = document.getElementById("tooltip");

    function showTooltip(evt, d) {
      if (!d.agentList) { tooltip.style.display = "none"; return; }
      const agents = d.agentList.split(", ");
      tooltip.innerHTML =
        '<div class="tt-title">' + d.title + '</div>' +
        '<div class="tt-label">Linked Agents</div>' +
        agents.map(a => '<div class="tt-agent">&bull; ' + a + '</div>').join("");
      tooltip.style.display = "block";
      positionTooltip(evt);
    }

    function positionTooltip(evt) {
      const pad = 12;
      let x = evt.clientX + pad;
      let y = evt.clientY + pad;
      const tw = tooltip.offsetWidth;
      const th = tooltip.offsetHeight;
      if (x + tw > window.innerWidth - pad) x = evt.clientX - tw - pad;
      if (y + th > window.innerHeight - pad) y = evt.clientY - th - pad;
      tooltip.style.left = x + "px";
      tooltip.style.top = y + "px";
    }

    function hideTooltip() {
      tooltip.style.display = "none";
    }

    // ── Node content renderers ──
    function fullNodeContent(d) {
      const o = d.data;
      const color = classColors[o.classification];
      const label = classLabels[o.classification];
      const levelDisplay = o.level.replace("-", " ").replace(/\b\w/g, c => c.toUpperCase());
      const agentBadge = o.linkedAgents > 0
        ? '<span style="background:' + color + '22; color:' + color + '; padding:1px 7px; border-radius:4px; font-size:11px; font-weight:500;">' + o.linkedAgents + ' agent' + (o.linkedAgents > 1 ? 's' : '') + '</span>'
        : '<span style="color:#94A3B8; font-size:11px;">No agents</span>';

      return '<div style="' +
        'width:' + d.width + 'px;' +
        'height:' + d.height + 'px;' +
        'display:flex;' +
        'align-items:center;' +
        'justify-content:center;' +
        '">' +
        '<div style="' +
          'width:' + (d.width - 4) + 'px;' +
          'height:' + (d.height - 16) + 'px;' +
          'background:#FFFFFF;' +
          'border-radius:8px;' +
          'border-left:4px solid ' + color + ';' +
          'box-shadow:0 1px 4px rgba(15,23,42,0.08), 0 1px 2px rgba(15,23,42,0.04);' +
          'padding:12px 14px;' +
          'display:flex;' +
          'flex-direction:column;' +
          'justify-content:space-between;' +
          'font-family:Inter,system-ui,sans-serif;' +
          'overflow:hidden;' +
        '">' +
          '<!-- Badge -->' +
          '<div style="display:flex; align-items:center; justify-content:space-between;">' +
            '<span style="' +
              'display:inline-block;' +
              'background:' + color + ';' +
              'color:#FFFFFF;' +
              'font-size:10px;' +
              'font-weight:600;' +
              'padding:2px 8px;' +
              'border-radius:10px;' +
              'text-transform:uppercase;' +
              'letter-spacing:0.04em;' +
            '">' + label + '</span>' +
            agentBadge +
          '</div>' +
          '<!-- Title -->' +
          '<div style="' +
            'font-family:Outfit,Inter,system-ui,sans-serif;' +
            'font-size:13px;' +
            'font-weight:600;' +
            'color:#0F172A;' +
            'line-height:1.3;' +
            'margin-top:6px;' +
          '">' + o.title + '</div>' +
          '<!-- Department -->' +
          '<div style="font-size:11px; color:#64748B; margin-top:2px;">' + o.department + '</div>' +
          '<!-- Meta -->' +
          '<div style="' +
            'display:flex;' +
            'justify-content:space-between;' +
            'font-size:11px;' +
            'color:#94A3B8;' +
            'margin-top:auto;' +
            'padding-top:6px;' +
            'border-top:1px solid #F1F5F9;' +
          '">' +
            '<span>Level: ' + levelDisplay + '</span>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    function compactNodeContent(d) {
      const o = d.data;
      const color = classColors[o.classification];
      const label = classLabels[o.classification];

      return '<div style="' +
        'width:' + d.width + 'px;' +
        'height:' + d.height + 'px;' +
        'display:flex;' +
        'align-items:center;' +
        'justify-content:center;' +
        '">' +
        '<div style="' +
          'width:' + (d.width - 4) + 'px;' +
          'height:' + (d.height - 12) + 'px;' +
          'background:#FFFFFF;' +
          'border-radius:6px;' +
          'border-left:4px solid ' + color + ';' +
          'box-shadow:0 1px 3px rgba(15,23,42,0.06);' +
          'padding:8px 12px;' +
          'display:flex;' +
          'align-items:center;' +
          'gap:10px;' +
          'font-family:Inter,system-ui,sans-serif;' +
          'overflow:hidden;' +
        '">' +
          '<span style="' +
            'display:inline-block;' +
            'background:' + color + ';' +
            'color:#FFFFFF;' +
            'font-size:9px;' +
            'font-weight:600;' +
            'padding:2px 6px;' +
            'border-radius:8px;' +
            'text-transform:uppercase;' +
            'letter-spacing:0.04em;' +
            'flex-shrink:0;' +
          '">' + label + '</span>' +
          '<div style="min-width:0;">' +
            '<div style="font-family:Outfit,Inter,system-ui,sans-serif; font-size:12px; font-weight:600; color:#0F172A; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">' + o.shortTitle + '</div>' +
            '<div style="font-size:10px; color:#94A3B8; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">' + o.department + '</div>' +
          '</div>' +
        '</div>' +
      '</div>';
    }

    // ── Build chart ──
    let chart;
    try {
      console.log('d3-org-chart loaded:', typeof d3.OrgChart);
      chart = new d3.OrgChart()
        .container("#chart")
        .data(data)
        .nodeWidth(d => isCompact ? 220 : 280)
        .nodeHeight(d => isCompact ? 70 : 140)
        .childrenMargin(d => 40)
        .siblingsMargin(d => 20)
        .compactMarginBetween(d => 25)
        .compactMarginPair(d => 50)
        .nodeContent(d => isCompact ? compactNodeContent(d) : fullNodeContent(d))
        .buttonContent(({ node, state }) => {
          const subs = node.data._directSubordinates;
          if (!subs) return "";
          const expanded = node.children;
          return '<div style="' +
            'display:flex;' +
            'align-items:center;' +
            'justify-content:center;' +
            'width:28px;' +
            'height:22px;' +
            'border-radius:5px;' +
            'border:1px solid #CBD5E1;' +
            'background:#FFFFFF;' +
            'font-size:11px;' +
            'font-family:Inter,system-ui,sans-serif;' +
            'color:#334155;' +
            'cursor:pointer;' +
          '">' + (expanded ? "−" : "+") + " " + subs + '</div>';
        })
        .linkUpdate(function(d, i, arr) {
          d3.select(this)
            .attr("stroke", "#94A3B8")
            .attr("stroke-width", 1.5)
            .attr("stroke-opacity", 0.6);
        })
        .nodeUpdate(function(d, i, arr) {
          d3.select(this)
            .on("mouseenter", function(event) {
              showTooltip(event, d.data);
            })
            .on("mousemove", function(event) {
              if (tooltip.style.display === "block") positionTooltip(event);
            })
            .on("mouseleave", function() {
              hideTooltip();
            });
        })
        .render();

      // Initial fit after a short delay for layout to settle
      setTimeout(() => chart.fit(), 300);
    } catch (e) {
      console.error('Chart init failed:', e);
      document.getElementById('chart').innerHTML =
        '<p style="padding:40px;color:#DC2626;">Chart failed to load. Check browser console.</p>';
    }

    // ── Compact toggle ──
    function toggleCompact() {
      if (!chart) return;
      isCompact = !isCompact;
      const btn = document.getElementById("compactBtn");
      btn.classList.toggle("active", isCompact);
      btn.textContent = isCompact ? "Detailed" : "Compact";

      chart
        .nodeWidth(d => isCompact ? 220 : 280)
        .nodeHeight(d => isCompact ? 70 : 140)
        .nodeContent(d => isCompact ? compactNodeContent(d) : fullNodeContent(d))
        .render()
        .fit();
    }

    // ── Export ──
    function exportChart() {
      if (!chart) return;
      chart.exportImg({
        full: true,
        save: true,
        fileName: "NexFolia-OrgChart"
      });
    }

    // ── Resize handling ──
    window.addEventListener("resize", function() {
      setChartHeight();
      if (chart) chart.fit();
    });
  </script>
</body>
</html>
